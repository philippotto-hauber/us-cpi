---
title: "Analyze disaggregated US CPI data"
author: "Philipp Hauber"
date: "June 9, 2021"
output: html_notebook
---

Source: [BLS](https://download.bls.gov/pub/time.series/cu/)

```{r}
rm(list = ls())
library(dplyr, warn.conflicts = FALSE)
library(tidyr)
library(readxl)
library(stringr)
library(lubridate)
library(ggplot2)
library(ggsci)

options(dplyr.summarise.inform = FALSE) # turn off annoying summarise warning!
```


# Data

## Download CPI series

[Link to bulk download of all series](https://download.bls.gov/pub/time.series/cu/cu.data.0.Current)
Download all series and keep all observations after and including 2020M1

```{r}
raw_dat <- read.table("https://download.bls.gov/pub/time.series/cu/cu.data.0.Current", sep="\t", header=TRUE)
df_series <- filter(raw_dat, year >= 2019)
rm(raw_dat)
```


Convert month to numeric variables and keep only monthly observations (discarding semi-annual and annual CPI levels)

```{r}
df_series %>% 
  separate(period, into = c("tmp", "month"), sep = 1) %>%
  filter(tmp == "M") %>%
  select(-tmp, -footnote_codes) %>%
  mutate(month = as.numeric(month),
         date = make_date(year = year, month = month)) %>%
  select(-year, -month) -> df_series
```

Split `series_id` into series code, filter `area` for **All city average** and `sa` for unadjusted data **U**

```{r}
df_series %>%
  separate(series_id, 
           into = c("tmp", "sa", "tmp2", "area", "series"), 
           sep = c(2,3,4,8)
           ) %>%
  filter(area == "0000",
         sa == "S") %>%
  mutate(series = str_trim(series)) %>%
  select(-tmp, -tmp2, -area, -sa) %>%
  drop_na() -> df_series
```

## Download names of CPI series

[Link to series names](https://download.bls.gov/pub/time.series/cu/cu.item)

```{r}
raw_names <- read.table(file = "https://download.bls.gov/pub/time.series/cu/cu.item", sep = "\t", header=T, stringsAsFactors = F, quote = "")

df_names <- select(raw_names, item_code, item_name, display_level)

rm(raw_names)
```

Merge names with series in `df`

```{r}
df <- merge(df_series, df_names, by.x = "series", by.y = "item_code")
df <- rename(df, name = item_name)
rm(df_names, df_series)
```

Filter out those series for which there are missing observations, i.e. the total number of observations is not equal to the nummber of observations available for the headline index!

```{r}
n_obs_all_items <- sum(df$name == "All items")

df %>% group_by(name) %>% summarise(n_obs = n()) %>% filter(n_obs == n_obs_all_items) -> list_keep

df <- filter(df, name %in% list_keep$name)

rm(list_keep)
```

## Download weights of CPI series

The relative components of the CPI vary from month to month. Rather than calculate them following the instructions given [here], I obtain them from the respective [Supplemental Files](https://www.bls.gov/cpi/tables/supplemental-files/home.htm) , which can be downloaded as xlsx-files. Note that for 2019, the tables are in a zip archive. 

Define a function to transform the raw, downloaded weights and 

- change column names
- remove single- and double-digit footnotes from `name`
- convert weights to numeric, level to integer (and factor)
- remove `NA`, blank lines

```{r}
transform_raw_weights <- function(raw_data)
{
  df <- raw_data[seq(6, nrow(raw_data)), seq(1, 3)]
  
  names(df) <- c("level", "name", "weight")
  df %>%
    mutate(level = factor(as.integer(level)),
           weight = as.numeric(weight),
           name = sapply(name, gsub, pattern = "\\(.\\)", replacement = ""),
           name = sapply(name, gsub, pattern = "\\(..\\)", replacement = "")) %>%
    filter(!is.na(weight)) -> df
  
  return(df)
}
```

### Weights for December 2020

The relative importance of the different items for December 2020 can be found in the Supplemental Tables of the January 2021 release

```{r}
url <- "https://www.bls.gov/cpi/tables/supplemental-files/news-release-table2-202101.xlsx"
fn <- "cpi_weights.xlsx"
download.file(url = url , destfile = fn, mode = "wb")
raw_weights <- read_excel(path = fn)
file.remove(fn)

raw_weights %>% 
  transform_raw_weights() %>% 
  mutate(year = "2020") %>% 
  rename(weight_Dec = weight) %>%
  select(-level)-> df_weights_Dec

rm(raw_weights, fn, url)
```

### Weights for December 2019

The relative importance of the different items for December 2020 can be found in the Supplemental Tables of the January 2021 release

```{r}
url <- "https://www.bls.gov/cpi/tables/supplemental-files/news-release-table2-202001.xlsx"
fn <- "cpi_weights.xlsx"
download.file(url = url , destfile = fn, mode = "wb")
raw_weights <- read_excel(path = fn)
file.remove(fn)

raw_weights %>% 
  transform_raw_weights() %>% 
  mutate(year = "2019") %>% 
  rename(weight_Dec = weight) %>%
  select(-level) %>%
  rbind(df_weights_Dec) -> df_weights_Dec

rm(raw_weights, fn, url)
```


### Calculate weights for all months and series

[Details on how to calculate the weights](https://www.bls.gov/cpi/tables/relative-importance/home.htm)


```{r}
df_weights <- data.frame()

# function to calculate ratio of index
ratio_of_index <- function(value, date, date1, date2)
  return(value[which(date == date2)] / value[which(date == date1)])
dates <- seq(as_date("2019-12-01"), as_date("2021-04-01"), by = "month") # calculate the weights for Jan20-May21!
for (ind_d in seq(1, length(dates)))
{
  d <- dates[ind_d]
  if (month(d) == 12) # no need to calculate weights for December!
          df_weights_Dec %>% 
            filter(year == year(d)) %>% 
            select(-year, weight = weight_Dec) %>% 
            mutate(date = d + months(1)) %>%
            rbind(df_weights) -> df_weights
  else
  {
          d_base <- make_date(year = year(d) - 1, month = 12)
          
          df_tmp <- merge(df, filter(df_weights_Dec, year == year(d_base)), by = "name")
          
          df_tmp %>%
            filter(name == "All items") %>%
            summarise(change_all = ratio_of_index(value, date, d_base, d)) %>% 
            select(change_all) -> change_all
          
          df_tmp %>%
            filter(name != "All items") %>% 
            group_by(name, weight_Dec) %>%
            summarise(change_series = ratio_of_index(value, date, d_base, d)) %>%
            mutate(new_weight = change_series * weight_Dec,
                   new_weight_normalized = new_weight / change_all[1,1]) %>% 
            ungroup() %>%
            select(name, weight = new_weight_normalized) %>%
            mutate(date = d + months(1)) %>%
            rbind(df_weights) -> df_weights
          
          # add All items which was filtered out above
          df_weights <- rbind(df_weights, data.frame(name = "All items", weight = 100.0, date = d + months(1)))
  }
}

rm(df_tmp, df_weights_Dec, change_all, d, d_base, ind_d, dates)
```


Merge with `df`

```{r}
#df <- merge(df, df_weights, by = c("name", "date"))
#(df_weights)
```

Alternative merge with `left_join`

```{r}
df <- left_join(df, df_weights, by = c("name", "date"))
```



## Download categories and levels (food, goods, services, energy)


```{r}
url <- "https://www.bls.gov/cpi/tables/supplemental-files/news-release-table2-202104.xlsx"
fn <- "cpi_weights.xlsx"
download.file(url = url , destfile = fn, mode = "wb")
raw_table2_apr2021 <- read_excel(path = fn)
file.remove(fn)

raw_table2_apr2021 %>%
  transform_raw_weights() %>%
  select(-weight) -> df_categories

df_categories$category <- "Goods"

start_food <- which(df_categories$name == "Food")
end_food <- which(df_categories$name == "Other food away from home")
df_categories$category[seq(start_food, end_food)] <- "Food"

start_energy <- which(df_categories$name == "Energy")
end_energy <- which(df_categories$name == "Utility (piped) gas service")
df_categories$category[seq(start_energy, end_energy)] <- "Energy"

start_services <- which(df_categories$name == "Services less energy services")
end_services <- which(df_categories$name == "Financial services")
df_categories$category[seq(start_services, end_services)] <- "Services"

df_categories$category[df_categories$name == "All items"] <- "Total"
df_categories$category[df_categories$name == "All items less food and energy"] <- "Total ex energy and food"

rm(raw_table2_apr2021, end_energy, end_food, end_services, start_energy, start_food, start_services, fn, url)
```


The `level` from the Supplemental Table does not match with `display_level` from the raw series. However, as I am unsure what the latter actually refers to, I discard it. 

Merge with `df` and reorder columns

```{r}
df <- merge(df, df_categories, by = "name")
df <- select(df, date, series, name, value, weight, category, level)
rm(df_categories)
```

# Analysis


## Auxiliary functions

```{r}
growth_rate <- function(x, dates, date1, date2)
#calculate growth rate of the CPI index between y1m1 and y2m2
{
  ind1 <- which(dates == date1)
  ind2 <- which(dates == date2)
  return(x[ind2] / x[ind1] * 100 - 100)
}
```





```{r}
rebase_index <- function(x, dates, date0)
# rebase index to 100 in y0m0
{
  ind0 <- which(dates == date0) 
  return(x / x[ind0] * 100)
}
```


## Distribution of m/m changes in April 2021


```{r}
df %>% 
    filter(level == 3) %>%
  group_by(name, category) %>%
  summarise(mm_apr21 = growth_rate(value, date, as_date("2021-03-01"), as_date("2021-04-01")),
            mm_may21 = growth_rate(value, date, as_date("2021-04-01"), as_date("2021-05-01")),
            )  %>%
  ggplot()+
  geom_histogram(aes(x = mm_may21), bins = 100, fill = "steelblue")
```


## Plot all time series

```{r}
df %>% 
  group_by(series, category, level) %>%
  mutate(value_rebased = rebase_index(value, date, "2020-02-01")) %>%
  ggplot(aes(x = date, y = value_rebased, group = series, color = category))+
  geom_line(aes(linetype = level))+
  geom_point()+
  scale_color_jco()
```


## Plot contributions of categories to m/m change

```{r}
df_mm <- data.frame()

yys <- c(2020:2021)
mms <- c(1:12)

for (yy in yys){
  for (mm in mms){
            if (yy == 2021 && mm > 5)
               break
            
            #if (yy == 2020 && mm == 1)
            #  next

              
            if (mm == 1){
              yy_prev <- yy-1
              mm_prev <- 12
            } else {
              yy_prev <- yy
              mm_prev <- mm - 1
            }
              
            df %>%
              filter(name %in% c("All items", 
                                "Energy", 
                                "Food", "Commodities less food and energy commodities",
                                "Services less energy services")
                     ) %>%
              group_by(name) %>%
              mutate(mm_growth = growth_rate(value, 
                                             date,
                                             make_date(year = yy_prev, month = mm_prev), 
                                             make_date(year = yy, month = mm)
                                             ), 
                     ) %>%
              filter(date == make_date(year = yy, month = mm)) %>%
              select(date, name, mm_growth, weight, category) %>%
              mutate(mm_growth_weighted = mm_growth * weight / 100) %>%
              ungroup() %>%
              rbind(df_mm) -> df_mm
  }
}

```

```{r}
df_mm %>% 
  filter(name != "All items") %>%
  ggplot(mapping = aes(x = date, y = mm_growth_weighted, group = name, fill = category),
         data = filter(df_mm, name != "All items"))+
  geom_col(position = 'stack')+
  scale_fill_jco()+
  geom_line(mapping = aes(x = date, y = mm_growth),
            data = filter(df_mm, name == "All items"), 
            color = "black", show.legend = FALSE)+
  geom_point(mapping = aes(x = date, y = mm_growth),
            data = filter(df_mm, name == "All items"), 
            color = "black", show.legend = FALSE)
```

Compare sum of weighted components with headline m/m growth

```{r}
df_mm %>% filter(name != "All items") %>% group_by(date) %>% summarise(sum_components = sum(mm_growth_weighted)) %>% select(date, sum_components) %>% merge(filter(df_mm, name == "All items"), by = "date") %>% select(sum_components, mm_growth) %>% round(digits = 2)
```

## Top movers in April and May 2021

```{r}
get_mm_growth_rate <- function(df, date_mm)
# find the n series with the largest m/m change
{
  df %>% 
    group_by(name) %>%
    summarise(mm_rate = growth_rate(value, 
                                    date, 
                                    date_mm - months(1), 
                                    date_mm)) %>%
    mutate(date = date_mm) -> df_tmp
    
  
  # add weights back
  df_out <- merge(df_tmp, 
                  select(df, name, date, weight,category), 
                  by = c("name", "date"))
  
  # calculate weighted growth
  df_out %>% mutate(mm_rate_weighted = mm_rate * weight/100) %>%
    arrange(mm_rate_weighted) -> df_out
}
```

April 2021
```{r}

df_apr21 <- get_mm_growth_rate(filter(df, level %in% c(4, 5, 6, 7, 8), 
                                          !(category %in% c("Energy", "Food"))),
                              date_mm = as_date("2021-04-01"))

df_apr21 %>% select(name, mm_rate, mm_rate_weighted)
```

May 2021
```{r}

df_may21 <- top_movers(filter(df, level %in% c(4, 5, 6, 7, 8), 
                              !(category %in% c("Energy", "Food"))),
                       date_mm = as_date("2021-05-01"), 
                       n = 20)

df_may21
```



```{r}
df %>%
  group_by(name, category) %>%
  summarise(value_mm = growth_rate(value, date, "2021-04-01", "2021-05-01")) %>%
  mutate(date = as_date("2021-05-01")) %>%
  select(name, date, value_mm, category)-> tmp

df %>%
  group_by(name, category) %>%
  summarise(value_mm = growth_rate(value, date, "2021-03-01", "2021-04-01")) %>%
  mutate(date = as_date("2021-04-01")) %>%
  select(name, date, value_mm, category) %>% rbind(tmp) -> tmp

tmp2 <- merge(tmp, select(df, name, date, weight), by = c("name", "date"))

df %>%
  group_by(name, category) %>%
  summarise(diff_pandemic = growth_rate(value, date, "2020-02-01", "2021-03-01")) %>%
  select(name, diff_pandemic)-> tmp

tmp3 <- merge(tmp2, tmp, by = "name")

tmp3$date_str <- "May 21"
tmp3$date_str[tmp3$date == as_date("2021-04-01")] <- "Apr 21"
  
```

### Plot

```{r}
tmp3 %>% 
  filter(name %in% c("Car and truck rental", 
                     "Airline fares", 
                     "Used cars and trucks",
                     "New vehicles",
                     "Admissions",
                     "Other lodging away from home including hotels and motels")) -> df_plot 

df_plot$name <- ifelse(df_plot$name == "Other lodging away from home including hotels and motels", "Hotels and motels", df_plot$name)

df_plot %>% group_by(name, diff_pandemic) %>% 
  summarise(y_coord = mean(value_mm)) %>%
  select(name, x_coord = diff_pandemic, y_coord) -> df_text

df_plot %>%
ggplot(aes(x = diff_pandemic, y = value_mm))+
  geom_point(aes(color = date_str, size = weight))+
  scale_color_jco()+
  ylim(c(0, 18))+
  scale_size(breaks = c(0.1, 0.5, 2), labels = c("0.1%", "0.5%", "2%"))+
  labs(title = "Vereinigte Staaten: Verbraucherpreisindex",
       subtitle = "Ausgewählte Waren und Dienstleistungen, Veränderung ggü. Vormonat im April und Mai 2021",
       caption = "Quelle: Bureau of Labor Statistics, eigene Berechnungen.",
       y="Veränderung ggü. Vormonat",
       x = "Veränderung März 2021 ggü. Februar 2020")+
  geom_vline(xintercept = 0)+
  geom_text(mapping = aes(x = x_coord, y = y_coord, label = name), 
            data = df_text,
            size = 4,
            nudge_x = 0.4,
            nudge_y = 0.4)
  
```


```{r}
ggsave(filename = "plot_cpi_US.pdf", width = 12, height = 6, units = "in")
```

